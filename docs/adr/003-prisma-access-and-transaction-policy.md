---
status: Accepted
date: 2025-09-09
related: [docs/CONVENTION.md, docs/adr/001-feature-architecture-and-dto-boundary.md]
---

# Prisma 접근 제약 및 트랜잭션 정책

## Context
데이터 접근이 서비스 전역에 산재하면 테스트가 어려워지고, 권한/무결성 규칙이 일관되게 적용되지 않는다. 또한 복수 쓰기 작업, 경쟁 조건, 외부 사이드이펙트와의 조합에서 트랜잭션 경계가 모호해진다. onat-remix는 Feature 기반 구조를 채택하고 있어, 데이터 접근 경계를 명확히 정의할 필요가 있다.

## Decision
1) Prisma 접근 위치 고정
   - Prisma 클라이언트는 오직 `app/features/<feature>/queries.server.ts`에서만 사용한다.
   - `service.server.ts`는 비즈니스 오케스트레이션만 담당하며 Prisma를 직접 호출하지 않는다.

2) 단일 클라이언트/연결 관리
   - 애플리케이션 전역에서 하나의 Prisma 클라이언트를 공유한다(일반적인 Remix 패턴 준수).

3) 트랜잭션 경계
   - 복수 테이블에 대한 쓰기 작업 또는 강한 일관성이 필요한 읽기-쓰기 묶음은 `queries.server.ts`에서 `prisma.$transaction`으로 묶는다.
   - 서비스 레이어는 “하나의 유스케이스 단위”로 쿼리 함수를 호출하되, 트랜잭션 내부에서 외부 사이드이펙트(S3, 이메일, 웹훅)는 실행하지 않는다.
   - 외부 사이드이펙트는 트랜잭션 커밋 이후에 수행하거나, 아웃박스 패턴을 적용한다.

4) 동시성/무결성 가이드
   - 고유 제약(Unique)과 적절한 인덱스를 스키마로 강제하고, 중복 삽입은 DB가 차단하도록 설계한다.
   - 조건부 업데이트(예: 상태 전이)는 where 절에 현재 상태를 포함해 경쟁 조건을 최소화한다.
   - 장기 실행 트랜잭션은 피한다. 사용자 입력/네트워크 호출을 트랜잭션 밖으로 이동한다.

5) 쿼리/서비스 분리 원칙
   - 쿼리: DB 접근, 변환 최소화, 예외를 구체 에러로 변환(optional).
   - 서비스: 입력 DTO 검증 완료 전제, 권한/도메인 규칙, 결과 조합. HTTP 객체 의존 금지.

## Consequences
- (장점) 데이터 접근 경로가 단일화되어 권한/정합성 규칙을 적용/점검하기 쉽다.
- (장점) 테스트 용이성 향상: 서비스는 Prisma 모킹 없이도 단위 테스트 가능.
- (장점) 트랜잭션 경계가 명확해 외부 사이드이펙트와의 결합에 따른 위험 감소.
- (트레이드오프) 초기에는 쿼리/서비스 분리로 파일 수와 보일러플레이트가 증가한다.

## Alternatives
- 대안 A: 서비스에서 Prisma 직접 사용
  - 장점: 파일/추상화 감소로 초기 속도↑.
  - 단점: 규칙 분산, 트랜잭션 경계 혼재, 테스트 어려움.
- 대안 B: 전역 Repository 계층 도입(Feature 무관 공용 레이어)
  - 장점: 공통화/중복 제거.
  - 단점: Feature 경계 희석, 공용 레이어 비대화, 변경 영향 범위 커짐.

## Migration
- Prisma 호출이 서비스/기타 위치에 있다면 `queries.server.ts`로 이동.
- 복합 쓰기 로직은 `prisma.$transaction`으로 감싸고, 외부 호출은 커밋 이후로 이동.
- Unique 제약/인덱스 점검 및 상태 전이 where 조건 보강.

## Notes
- Prisma 스키마 변경 후: `pnpm exec prisma generate` → `pnpm exec prisma migrate dev`
- 테스트에서는 쿼리를 얕게 모킹하고 서비스는 순수 로직 검증을 우선한다.
