자체전 팀 시스템 리팩토링: 설계 / 계획 문서

0. 목표 요약
	•	자체전에서 팀 단위 경쟁·통계를 보여줘서 박진감을 높인다.
	•	한 기간 동안 한 선수는 두 팀 중 하나에만 소속될 수 있게 한다.
	•	기존 매치전(타 클럽과 경기) 로직은 최대한 건드리지 않고,
자체전 전용 레이어로 팀 시스템을 덧씌운다.
	•	Codex가 이 문서를 기반으로 코드/화면/API를 구현할 수 있도록
도메인–UX–API–통계–마이그레이션까지 흐름을 명확히 정의한다.

⸻

1. 도메인 개념 정리

1-1. 용어 정의
	•	자체전(Intra Match)
	•	같은 클럽 안에서 2개 팀이 나뉘어 붙는 경기.
	•	고정 팀(ClubTeam)
	•	클럽 내부에서 계속 유지되는 팀 단위 (예: 레드팀, 블루팀).
	•	통계/랭킹의 기준이 되는 엔티티.
	•	경기 팀(Team)
	•	특정 경기에서 실제로 사용되는 팀 인스턴스.
	•	Quarter, Assigned, Record 등과 연결되는 기존 구조 유지.
	•	팀 멤버십(ClubTeamMember)
	•	“어떤 선수가 어느 고정 팀에 속해 있는지”를 나타내는 관계.

1-2. 도메인 요구사항 체크리스트
	•	한 클럽에는 최소 2개의 고정 팀이 존재할 수 있다. (레드/블루)
	•	한 선수는 여러 고정 팀에 동시에 속할 수 있다. 시즌/기간별 템플릿을 여럿 둘 수 있어 단일 팀 제약을 두지 않는다.
	•	자체전 경기는 항상 “고정 팀 A vs 고정 팀 B”의 형태를 가진다.
	•	통계는 “고정 팀 기준”으로 집계된다.
	•	팀별 승/무/패, 득실점, 승률
	•	최근 경기 성적
	•	매치전(대외 경기)은 기존처럼 클럽 vs 클럽 기준으로 유지하며,
고정 팀 통계에 포함하지 않는다.

⸻

2. 데이터 모델 변경 정리



2-1. 신규/수정 엔티티
	•	Club
	•	고정 팀 리스트: clubTeams (1:N, Club → ClubTeam)
	•	ClubTeam
	•	속한 클럽: club
	•	이름/색상/사용 여부: name, color, isUse
	•	멤버십: members (ClubTeamMember[])
	•	이 팀이 참여한 경기의 Team 인스턴스: matchTeams (Team[])
	•	기간별 팀 통계: statsHistories (ClubTeamStatsHistory[])
	•	ClubTeamMember
	•	어떤 고정 팀인지: clubTeam
	•	어떤 선수인지: player
	•	팀 내 역할: isCaptain 등
	•	제약: “한 선수는 하나의 고정 팀만 가진다” (v1)
	•	도메인 규칙으로 정의 + DB 제약(유니크) 여부는 별도 결정
	•	ClubTeamStatsHistory
	•	고정 팀: clubTeam
	•	집계 단위: periodType, periodKey
	•	통계 값: matchCount, winCount, drawCount, loseCount, totalGoal, totalConcede
	•	Team (경기 팀)
	•	기존 필드 유지 (name, color, matchClubId 등)
	•	고정 팀 연결: clubTeam (optional, 자체전에서 필수로 요구. 없으면 생성/선택 플로우로 유도)
	•	자체전에서만 설정, 매치전에서는 null 가능

2-2. “한 선수 = 한 팀” 제약 설계

v1 기준 도메인 규칙:
	•	한 클럽에서 자체전 시스템을 사용할 때,
각 Player는 여러 ClubTeamMember를 가질 수 있다(템플릿/기간별 재구성 허용).
	•	팀 이동은 “기존 ClubTeamMember 삭제 → 새 ClubTeamMember 생성” 패턴으로 처리.
	•	시즌 개념은 초기에는 도입하지 않는다.
	•	추후 필요 시 seasonKey 같은 필드 추가로 확장.
	•	DB 제약은 `@@unique([clubTeamId, playerId])` + `@@index([playerId])`만 적용.
	•	동일 선수의 다중 팀 소속을 도메인 차원에서 막지 않는다(소프트 삭제 없음, 행 삭제 방식).

⸻

3. 화면 / UX 플로우 설계

3-1. 전체 화면 목록
	•	자체전 팀 관리 화면 (클럽 설정)
	•	자체전 경기 생성 플로우 (기존 매치 생성 확장)
	•	자체전 팀 편성(드래그 앤 드롭) 화면
	•	자체전 팀 랭킹/통계 화면
	•	팀 상세 화면 (선수/그래프/전적)

3-2. 화면 1: 자체전 팀 관리

목적:
클럽 관리자가 “고정 팀”을 정의하고 이름/색상 설정.

기능:
	•	고정 팀 리스트 조회
	•	팀 추가 (이름/색상/사용 여부)
	•	팀 이름 변경, 색상 변경
	•	팀 사용/미사용 토글 (미사용 팀은 새 경기 편성에서 숨김)
	•	색상 입력 규칙: 팔레트 라이브러리로 선택된 HEX 문자열(`#000000` 형식) 저장/표현.

UX:
	•	상단: “고정 팀 관리” 제목 + 설명 텍스트
	•	중간: 팀 카드 리스트 (이름, 색상, 인원 수, 총 전적 간단 요약)
	•	하단: “새 팀 추가” 버튼

3-3. 화면 2: 팀 편성 (한 선수 = 한 팀)

목적:
한 선수가 두 팀에 중복 소속되지 않도록, 물리적으로 한 화면에서만 배치.

레이아웃:
	•	좌측: “미배정 선수”
	•	가운데: “팀 A (레드팀)”
	•	우측: “팀 B (블루팀)”

동작:
	•	드래그 앤 드롭으로 컬럼 간 이동
	•	클릭 기반 “추가/제거” 버튼도 지원 (모바일 대응)
	•	현재 편성 세션(단일 템플릿/기간) 내에서는 한 선수를 중복 배치하지 않도록 UI/서버에서 방지

서버 연동 규칙:
	•	한 선수를 어느 컬럼으로 옮기는 순간,
기존 ClubTeamMember를 모두 제거하고, 새 팀으로 ClubTeamMember를 생성
	•	“미배정” 컬럼으로 옮기면 해당 선수의 ClubTeamMember 삭제

3-4. 화면 3: 자체전 경기 생성 플로우

목적:
자체전 경기를 만들면서, 어떤 고정 팀끼리 붙는지 선택.

플로우:
	1.	매치 생성 화면에서 “경기 종류” 선택:
	•	옵션: 일반 매치 / 자체전
	2.	자체전 선택 시:
	•	클럽 선택 (현재 클럽으로 고정해도 됨)
	•	팀 A, 팀 B 선택 (ClubTeam 중에서 2개 선택, 기본값: 대표 두 팀)
	3.	저장 시:
	•	Match, MatchClub 생성
	•	Team 인스턴스 2개 생성 (각각 clubTeam 연결)
	•	각 팀의 ClubTeamMember를 조회해 Attendance 기본값 생성 (옵션)
	4.	이후는 기존 매치 화면/쿼터 배정 로직과 동일하게 진행

3-5. 화면 4: 자체전 팀 랭킹/통계

목적:
양 팀이 “누가 더 잘 하고 있는지” 직관적으로 보여주는 대시보드.

구성:
	•	상단: 기간 선택 (전체 / 올해 / 이번 분기) — 커스텀 범위는 v1 범위 밖
	•	중간: 두 팀 카드 비교
	•	팀 이름/색상
	•	승/무/패, 득실차
	•	승률
	•	최근 5경기 결과 요약
	•	하단: 최근 자체전 리스트 (날짜, 스코어, MOM 등)

필요 데이터:
	•	ClubTeamStatsHistory (선택한 기간 필터)
	•	해당 기간의 Match / MatchClub / Record 집계 결과

3-6. 화면 5: 팀 상세

목적:
한 팀의 히스토리를 단독으로 보는 상세 화면.

구성:
	•	상단: 팀 정보(이름, 색상, 인원 수, 전체 전적 요약)
	•	중앙: 그래프
	•	경기별 득점/실점
	•	승률 변화 등
	•	하단: 선수 목록
	•	출석률, 평균 평점, 득점/어시스트 등

⸻

4. 백엔드 / API 설계

각 API는 “목적 / 요청 / 응답 / 에러 / 비즈니스 규칙” 중심으로 정의.
여기서는 엔드포인트 이름 정도만 나열.

4-1. 팀 관리 관련
	•	GET 클럽 고정 팀 목록
	•	POST 고정 팀 생성
	•	PATCH 고정 팀 수정(이름/색상/isUse)

4-2. 팀 편성 관련
	•	GET 팀 편성 화면용 데이터
	•	미배정 선수, 각 팀별 선수 목록
	•	POST/PUT 선수 팀 이동
	•	입력: playerId, targetTeamId 또는 targetStatus(미배정)
	•	비즈니스 규칙:
	•	항상 트랜잭션으로 처리
	•	기존 팀 멤버십 제거 후 새 멤버십 생성

4-3. 자체전 경기 생성 관련
	•	GET 자체전용 초기 데이터 (사용 가능한 ClubTeam 목록)
	•	POST 자체전 매치 생성
	•	입력: 클럽, 팀A, 팀B, 기본 매치 정보
	•	내부 비즈니스:
	•	Match/MatchClub 생성
	•	Team 인스턴스 2개 생성 (각각 clubTeam 연결)
	•	필요 시 Attendance 기본 생성
	•	MatchClub 생성 전략: 기존 구조 유지(매치당 클럽 1개). 자체전은 동일 클럽을 중복 생성하지 않고 단일 MatchClub 아래 Team 2개로 구성.

4-4. 통계/랭킹 관련
	•	GET 자체전 팀 랭킹
	•	입력: 클럽, 기간(옵션)
	•	출력: 팀별 승/무/패, 득실, 승률 등
	•	GET 팀 상세 통계
	•	입력: 클럽, teamId, 기간
	•	출력: 경기 리스트, 그래프용 데이터, 선수별 요약 등

⸻

5. 통계 집계 로직 설계

5-1. 언제 집계할 것인가?

선택지:
	•	A. 경기 종료 시 즉시 집계 (동기/비동기 Job)
	•	B. Cron으로 주기적 집계 (예: 매일 새벽)

v1 제안:
	•	Record(득점 등) 발생 시점에 바로 ClubTeamStatsHistory 업데이트(동기/비동기).
	•	Cron 재계산은 v1에서 고려하지 않음.
	•	기간 유형: StatsPeriodType에 ALL 추가, periodKey는 “all” 사용.

5-2. 승/무/패 계산 기준
	•	하나의 자체전 Match에서:
	•	Team(=경기 팀)마다 득점을 합산
	•	득점 비교 후 승/무/패 결정
	•	두 Team 모두 같은 ClubTeamStatsHistory에 반영

5-3. 통계 포인트
	•	teamId 기준 → clubTeamId로 집계
	•	Record / Quarter / Attendance를 참조
	•	기간 필터:
	•	StatsPeriodType + periodKey 활용
	•	“전체/연/분기/월” 단위까지는 지원

⸻

6. 권한 / 에지 케이스

체크리스트:
	•	팀 관리/편성은 클럽 관리자(MASTER/MANAGER 이상)만 가능
	•	팀 편성 중에 선수 탈퇴/정지 상태 변경 시 어떻게 처리할지
	•	고정 팀 삭제/비활성화 시:
	•	기존 경기 통계는 유지
	•	새 경기에서는 선택되지 않도록 처리
	•	동일 선수를 두 팀에 넣으려는 요청 발생 시 서버에서 에러 처리
	•	자체전이 아닌 매치에는 고정 팀 통계를 절대 섞지 않기
	•	베타 플래그: 단독 운영이라 필수는 아님. 필요 시 ENV/DB 설정으로 토글 가능하게 설계 검토.

⸻

7. 마이그레이션 계획

7-1. 단계별 적용

1단계 – 모델 및 기본 구조 도입
	•	ClubTeam / ClubTeamMember / ClubTeamStatsHistory 스키마 추가
	•	기존 로직과 충돌 없는지 확인 (매치전 unaffected)
	•	관리 화면 없이, DB에서 직접 더미 데이터 넣어 테스트

2단계 – 관리자 UI 도입
	•	“고정 팀 관리” 화면 구현
	•	팀 편성 화면 (미배정/팀A/팀B) 구현
	•	실제 DB의 ClubTeamMember 와 연동

3단계 – 자체전 매치 생성 연동
	•	자체전 선택 시 고정 팀 선택 기능 추가
	•	Team 인스턴스에 clubTeamId 연결
	•	Attendance 자동 생성 등 기본 로직 구현

4단계 – 통계/랭킹 화면 및 집계 Job
	•	ClubTeamStatsHistory 집계 Job 작성
	•	랭킹/상세 UI 구현
	•	실제 자체전 몇 경기 치르면서 검증

7-2. 롤아웃 전략
	•	초기엔 “자체전 베타” 플래그를 두고 특정 클럽만 활성화
	•	문제가 없으면 전체 클럽으로 확장
